<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>autostart | ST</title> <meta name="author" content="Sean Trautman"/> <meta name="description" content="Intro to starting programs on boot"/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="" id="highlight_theme_light"/> <link rel="shortcut icon" href="/assets/img/st-logo-transparent.png"/> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://straut12.github.io/ref/linux/autostart/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <div class="site-container"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">ST</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/"></a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Coding</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/ref/coding/git/">VScode Github</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/coding/bash/">Bash Shell</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/coding/python/">Python</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/coding/js/">JavaScript</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/coding/html/">Web HTML</a> </div> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Data Analysis</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/ref/data-analysis/data-collection/">data collection</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/data-analysis/databases/">databases</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/data-analysis/basic-charting/">basic charting</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/data-analysis/data-visualization/">data visualization</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/data-analysis/ml/">machine learning</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/data-analysis/statistics/">notes</a> </div> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Linux</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/ref/linux/linuxdistros/">Linux Options</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/desktop/">Desktop Appearance</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/software/">Installing SW</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/sharing/">File Sharing</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/vnc-ssh/">Remote vnc ssh</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/terminal/">Terminal cli</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/autostart/">Autostart systemd</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/logs/">Logs</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/list/">List of SW to Install</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="site-body wrapper"> <aside class="site-sidebar" id="site-sidebar"> <nav class="toc"> <header><h4 class="toc__title">Table of Contents</h4></header> <ul class="toc__menu"> <li><a href="#start-at-boot">Start at Boot</a></li> <li><a href="#ubuntu-options">Ubuntu Options</a></li> <li><a href="#raspberry-pi-options">Raspberry Pi Options</a></li> <li> <a href="#systemd">Systemd</a> <ul> <li><a href="#build-a-test-start-at-boot-service">Build a Test Start-at-Boot Service</a></li> <li><a href="#create-service-unit">Create Service Unit</a></li> <li><a href="#check-boot-log-for-targets">Check boot log for Targets</a></li> <li><a href="#enable-testservice-to-start-at-boot">Enable test.service to Start at Boot</a></li> </ul> </li> <li><a href="#terms-and-systemctl-commands">Terms and systemctl commands</a></li> </ul> </nav> </aside> <main> <div class="post"> <p class="post-description">Intro to starting programs on boot</p> <article> <p>This section is geared for STEM projects working with RPis.</p> <h1 id="start-at-boot">Start at Boot</h1> <p><strong>Options for Starting an Application at Startup (or scheduled time)</strong></p> <p>Below are some options for making a program automatically launch during start up. This is useful for programs setting up your desktop environment and accessibility (a dock, conky, vnc, ssh, mqtt) or if you have a python script you want to automatically start up (send output to a screen, start collecting sensor data, etc). You could also schedule a script that does some function every hour, every minute, etc.</p> <p>One thing to consider is if the program/service you’re starting is graphical (GUI) and needs the desktop/login or needs to login to the network wifi. It will be helpful to have a little background on the boot/start up process.</p> <p><strong>Linux boot process</strong></p> <ul> <li> <a href="https://en.wikipedia.org/wiki/BIOS" target="_blank" rel="noopener noreferrer">BIOS</a> <a href="https://en.wikipedia.org/wiki/Power-on_self-test" target="_blank" rel="noopener noreferrer">POST</a> - Power On Self Test. BIOS checks/initializes the hardware. Loads MBR.</li> <li> <a href="https://en.wikipedia.org/wiki/Master_boot_record" target="_blank" rel="noopener noreferrer">MBR</a> - Master Boot Record. Located at beginning of boot disk. Loads GRUB2/bootloader.</li> <li> <a href="https://en.wikipedia.org/wiki/GNU_GRUB" target="_blank" rel="noopener noreferrer">Bootloader</a> – GRUB2 for Linux. Primary job is get the operating system kernel (Linux) loaded into memory and executing.</li> <li> <a href="https://en.wikipedia.org/wiki/Linux_kernel" target="_blank" rel="noopener noreferrer">Kernel</a> - Located in /boot. Executes init (/sbin/init) and hands over to systemd (start up).</li> </ul> <p><strong>End of boot</strong><br> <strong>Start-up Process begins</strong></p> <ul> <li> <a href="https://en.wikipedia.org/wiki/Systemd" target="_blank" rel="noopener noreferrer">systemd</a> – System and service manager (d for daemon). The init system that takes over the boot process from the bootloader (GRUB2) and starts the rest of the system. init is the first process started. <code class="language-plaintext highlighter-rouge">$ ps aux</code> will show it as PID1. It will mount the file systems defined in /etc/fstab and then starts up and maintains userspace services. End of Start Up and PC is Running</li> <li> <a href="https://en.wikipedia.org/wiki/User_space_and_kernel_space" target="_blank" rel="noopener noreferrer">userspace</a> - Code running outside the kernel space or after kernel is booted.</li> </ul> <p>There are multiple options for having a program start at boot<br> <strong>Startup Options</strong></p> <ul> <li>systemd (most options/complex)​​</li> <li>cron (also a scheduler)</li> <li>“Startup Applications” in desktop settings (GNOME/MATE)</li> <li>“autostart” file (RPi with LXDE)</li> <li>.desktop files in autostart folder (when X session started)</li> </ul> <p><em>​Older method (deprecated)</em></p> <ul> <li>rc.local</li> </ul> <hr> <p>To help debug a program during startup (and if not using systemd) modify your ExecStart/Command temporarily to log the output of your python print statements and errors..<br> example<br> <code class="language-plaintext highlighter-rouge">/bin/bash -c '/usr/bin/python3 /home/pi/script.py &gt; /home/pi/script.log 2&gt;&amp;1'</code></p> <p>Explanation<br> stdout=1, stderr =2<br> &gt; tells stdout (python print statements) to go to the .log file<br> 2&gt;&amp;1 tells stderr(2) to go to the same place as stdout (1). So both will go to the .log file. (is also a way of executing a script and not having the errors show on the terminal)</p> <hr> <h1 id="ubuntu-options">Ubuntu Options</h1> <p>​​Ubuntu (GNOME/MATE desktop environment) Options</p> <ol> <li>Startup Application (in desktop environment after login)</li> <li>Cron (scheduler and at startup)</li> <li>Systemd is the most complex but most thorough</li> </ol> <p><strong>Startup Application</strong> GNOME/MATE have a simple method for starting on boot. In settings search for “startup” and select “startup application”. The command line will use the similar format as in a .desktop file.</p> <p>Some example command lines</p> <ul> <li>/usr/lib/firefox-esr/firefox-esr (full path to firefox-esr executable since /usr/lib is not in the $PATH)</li> <li>vncviewer (vncviewer executable is in /usr/bin/, which is in $PATH, so do not need the full path)</li> <li>sh -c ‘sudo ./test.py’ (Run shell/bash and using sudo. Note- test.py was made executable and has shebang with python version specified)</li> <li>You can check $HOME/.config/autostart for the .desktop file that is created.</li> <li>In Gnome, to disable the autostart, a X-GNOME-Autostart-enabled=false can be used in the .desktop file.</li> <li>​Try running the shell in a terminal if it is not starting.</li> </ul> <p>​Alacarte (used on RPi) can be installed and then used to view exec commands for other application icons. See <a href="../../../ref/linux/desktop/">desktop</a> section</p> <p><strong>Cron (scheduler and @boot)</strong></p> <ul> <li>to install <code class="language-plaintext highlighter-rouge">$ sudo apt-get install gnome-schedule</code> </li> <li>run <code class="language-plaintext highlighter-rouge">$ crontab -e</code> </li> <li>select your editor (I use nano)</li> <li>often a delay may be necessary with “sleep 30” or other amount in the command line. See examples below. It is a good practice to use a shell file that handles the delay and launching your program. Then put the shell file in cron.<br> There are directions in the crontab. Examples below in RPi Section. Or <a href="https://help.ubuntu.com/community/CronHowto" target="_blank" rel="noopener noreferrer">Ubuntu community</a> has examples.</li> </ul> <hr> <h1 id="raspberry-pi-options">Raspberry Pi Options</h1> <p>Raspberry Pi</p> <ol> <li>Cron (scheduler and @reboot)</li> <li>rc.local DEPRECATED</li> <li>Autostart script or folder (for .desktop files)</li> <li>Systemd is most complex. Some guidelines are at the bottom.</li> </ol> <p><strong>1-Cron (scheduler and @boot)</strong> Raspberry Pi OS will have cron already installed. If not installed do</p> <ul> <li><code class="language-plaintext highlighter-rouge">$ sudo apt update</code></li> <li><code class="language-plaintext highlighter-rouge">$ sudo apt install cron</code></li> <li> <code class="language-plaintext highlighter-rouge">$ sudo systemctl enable cron</code><br> Once Installed</li> <li>run $ crontab -e</li> <li>select your editor (I use nano) There are directions in the crontab<br> At the bottom you will enter the program to run</li> </ul> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w">	</span>m	h	dom	mon	dow	<span class="nb">command</span>	
<span class="gp">0	5	*	*	1	tar -zcf /var/backups/home.tgz /home/	#</span>weekly backup
<span class="gp">0	0	*	*	*	/home/pi/backup.sh	#</span>this would run backup.sh every day at midnight
<span class="gp">*	*	*	*	*	sh /home/pi/script.sh 2&gt;</span>&amp;1	<span class="c"># run script.sh every minute</span>
<span class="gp">@reboot sudo python3 /home/pi/script.py &amp;	#</span><span class="w"> </span>run script.py at boot <span class="o">(</span>&amp; means <span class="k">in </span>background so pi keeps booting<span class="o">)</span>
</code></pre></div></div> <p>Save, reboot $ sudo reboot 0 <br> Some other useful options<br> often a delay may be necessary with “sleep 30” or other amount in the command line. It is a good practice to use a shell file that handles the delay and launching your program. Then put the shell file in cron.<br> <code class="language-plaintext highlighter-rouge">$ crontab -l</code>(list scheduled tasks)<br> <code class="language-plaintext highlighter-rouge">$ cd logs</code><br> <code class="language-plaintext highlighter-rouge">$ cat cronlog</code>(view log when it doesn’t run correctly)</p> <p>Try a simple test first and add this line to cron<br> <code class="language-plaintext highlighter-rouge">@reboot echo "cron test" &gt; /home/USER/crontest.txt 2&gt;&amp;1</code><br> Then reboot and check crontest.txt for success</p> <hr> <p><strong>2- Editing rc.local is often suggested but it is now deprecated</strong><br> $ sudo nano /etc/rc.local<br> Add lines similar to cron (without the @reboot) sudo python3 /home/pi/script.py &amp;<br> Add commands below the comment but leave the ‘exit 0’ line at the end. Save, reboot.<br> Note - as shown in shebang section you could make the files executable and add a shebang header instructing which program to use for executing.</p> <hr> <p><strong>3- Auto-start using autostart script or .desktop files</strong><br> ​Autostart script Method<br> For RPi running MATE or GNOME desktop follow Ubuntu instructions above.. use “startup applications”</p> <p>For RPi running default LXDE see below<br> Locations (for RPi, ~ = /home/pi/)</p> <ul> <li>~/.config/lxsession/LXDE-pi/autostart (local)</li> <li>/etc/xdg/lxsession/LXDE-pi/autostart (global)</li> <li>If no user (~) autostart script is found it will run global script in /etc/ instead. <strong>It does not run both automatically.</strong> My RPi already has entries in the /etc/xdg.. script so I edited that one.<br> But a better method is to <ol> <li>create/edit the local and put your user commands in this file.</li> <li>Then have your local autostart the global by making the first line below..​</li> </ol> </li> </ul> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">@/etc/xdg/lxsession/LXDE-pi/autostart
</span></code></pre></div></div> <ul> <li>Guidelines/notes</li> <li>Commands are started in parallel</li> <li>Enter the full path to your script (do not use ~ or .)</li> <li>” “ and ‘ ‘ and escaping with \ are not allowed (do not try and reference a directory that has a space in it)</li> <li>Can put comments on the same line after a #</li> <li>Use -e for using a terminal (@lxterminal -e /path/to/script)</li> <li>@ means your script will be started again if it fails</li> <li>Put your script before the xscreensaver entry.<br> <code class="language-plaintext highlighter-rouge">$ sudo nano /etc/xdg/lxsession/LXDE-pi/autostart</code> </li> </ul> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">@lxpanel --profile LXDE-pi
@pcmanfm --desktop --profile LXDE-pi

@compton
@plank
@/usr/bin/python3 /home/pi/test.py
​
@xscreensaver -no-splash
</span></code></pre></div></div> <hr> <p><strong><a href="https://specifications.freedesktop.org/autostart-spec/0.5/ar01s02.html" target="_blank" rel="noopener noreferrer">Autostart folder</a> Method</strong><br> You create a .desktop file for the program and place it in the folder below</p> <ul> <li>~/.config/autostart</li> <li>/etc/xdg/autostart</li> <li>If there is a duplicate .desktop file in both directories the ~/.config has priority<br> ​​ Example for application flameshot</li> <li>Find where the executable is <code class="language-plaintext highlighter-rouge">$ whereis flameshot</code> returns /usr/bin/flameshot (/usr/bin/ is in $PATH so do not need full path for flameshot)</li> <li>Now create a .desktop file and put it in the ‘autostart’ folder <code class="language-plaintext highlighter-rouge">$ sudo nano /etc/xdg/autostart/flameshot.desktop</code><br> ​ Reboot to confirm the application starts up. Instead of a application you could have a shell file that performs some function at startup.</li> </ul> <hr> <h1 id="systemd">Systemd</h1> <p>What is <a href="https://en.wikipedia.org/wiki/Systemd" target="_blank" rel="noopener noreferrer">systemd</a> and why would you use it? Systemd starts and manages background processes like the network, bluetooth, ssh server, printer, etc. Systemd itself is a background process. On a Raspberry Pi, if text output is selected in raspi-config, you’ll see systemd updates on your screen during the boot. If you have a python script you want to start during boot you can create your own systemd service unit and use the systemctl commands to manage it. Although it is more work than just adding a line to cron or using the built-in autostart/startup script it is has more options and built-in logging. Ultimately it’s up to the user to decide what option is best for their case. Inevitably you will have to use the systemctl commands anyway to start, stop, enable, disable services on many applications (vnc servers, ssh, node-red, influxd, etc). So I decided to go ahead and learn how to create my own systemd service to understand how it works. There is a significant learning curve at first (compared to other start up methods) but I found the logging (journald) and systemctl commands to be very useful.​</p> <p>A good tutorial on using systemd is at <a href="https://learn.sparkfun.com/tutorials/how-to-run-a-raspberry-pi-program-on-startup#method-3-systemd" target="_blank" rel="noopener noreferrer">sparkfun</a></p> <h2 id="build-a-test-start-at-boot-service">Build a Test Start-at-Boot Service</h2> <p>An effective method to better understand systemd is to build your own service. One of the common reasons for building your own service is for having a script start at boot or scheduled to run at specific times. This will involve creating a service unit where you specify the location of your script and what part of the boot process to start it. For the latter part it helped me to look at the boot logs and see when the current services are started with respect to different targets. By adding a logging line to my script I could see where it started in the log too. If I needed to change it I could try different settings in my service unit, reboot, and check the logs to see where it landed in the boot timeline.</p> <p>​Create a python script for the service unit to execute<br> I created a python script that imported some systemd and journal (systemd logging tool) libraries to help make it evident where my python script was in the boot timeline. These modules wouldn’t be necessary in a regular python script but I found them useful for my first systemd testing.</p> <p><code class="language-plaintext highlighter-rouge">$ sudo apt install python3-systemd</code><br> <code class="language-plaintext highlighter-rouge">$ nano myscript.py </code><br> don’t forget to make it executable with<br> <code class="language-plaintext highlighter-rouge">$ chmod +x myscript.py</code></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">import</span> <span class="n">systemd.daemon</span>
<span class="kn">from</span> <span class="n">systemd.journal</span> <span class="kn">import</span> <span class="n">JournalHandler</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Testing a script to be started by systemd at boot</span><span class="sh">'</span><span class="p">)</span>
<span class="n">jlogger</span> <span class="o">=</span> <span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="sh">'</span><span class="s">journal</span><span class="sh">'</span><span class="p">)</span>            <span class="c1"># Create a generic logger
</span><span class="n">jlogger</span><span class="p">.</span><span class="nf">addHandler</span><span class="p">(</span><span class="nc">JournalHandler</span><span class="p">())</span>           <span class="c1"># Add a journal type handle
</span><span class="n">jlogger</span><span class="p">.</span><span class="nf">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="p">.</span><span class="n">INFO</span><span class="p">)</span>                      <span class="c1"># Set to INFO level so all info is logged
</span><span class="n">jlogger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Journal updated by </span><span class="sh">'</span> <span class="o">+</span> <span class="n">__file__</span><span class="p">)</span> <span class="c1"># Add a comment to the journal
</span><span class="n">systemd</span><span class="p">.</span><span class="n">daemon</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="sh">'</span><span class="s">READY=1</span><span class="sh">'</span><span class="p">)</span>             <span class="c1"># Notifies systemd the script ran
</span></code></pre></div></div> <h2 id="create-service-unit">Create Service Unit</h2> <p>Now start creating your service unit in /lib/systemd/system/<br> <strong>Important</strong> - syntax is important. No spaces before/after the equal sign. And it is best to type the syntax instead of copy/paste from somewhere else. Your service may have problems if there are extra spaces.</p> <p><code class="language-plaintext highlighter-rouge">$ sudo nano /lib/systemd/system/mytest.service</code></p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Unit]
Description=Creating my own systemd service
</span></code></pre></div></div> <p>To see your unit file<br> <code class="language-plaintext highlighter-rouge">$ systemctl list-unit-files | grep 'mytest'</code></p> <hr> <p>Add a Service section where you specify the location of the python script<br> <code class="language-plaintext highlighter-rouge">$ sudo nano /lib/systemd/system/mytest.service</code></p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Unit]
Description=Creating my own systemd service

[Service]
ExecStart=/home/pi/myscript.py
</span></code></pre></div></div> <hr> <p>Now reload the daemon service and start your service<br> <code class="language-plaintext highlighter-rouge">$ sudo systemctl daemon-reload</code><br> <code class="language-plaintext highlighter-rouge">$ sudo systemctl start mytest.service</code><br> <code class="language-plaintext highlighter-rouge">$ systemctl status mytest.service</code> (this will show the status of your service along with logs) Could also check<br> <code class="language-plaintext highlighter-rouge">$ journalctl --since "1 hour ago"</code></p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">● mytest.service - Creating my own systemd service
</span><span class="gp">Loaded: loaded (/lib/systemd/system/mytest.service;</span><span class="w"> </span>static<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
<span class="go">Active: inactive (dead)

Mar 13 13:44:36 raspberrypi systemd[1]: Started Creating my own systemd service.
Mar 13 13:44:36 raspberrypi /home/pi/myscript.py[1945]: Journal updated by /home/pi/myscript.py
Mar 13 13:44:36 raspberrypi myscript.py[1945]: Testing a script to be started by systemd at boot
Mar 13 13:44:36 raspberrypi systemd[1]: mytest.service: Succeeded.
</span></code></pre></div></div> <hr> <h2 id="check-boot-log-for-targets">Check boot log for Targets</h2> <p>To have our service start our myscript.py script at boot we need to add an Install section. But first I wanted to look at a boot log to see when different targets were reached.<br> <code class="language-plaintext highlighter-rouge">$ journalctl -b | grep 'Reached target'</code></p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Mar 09 16:42:37 raspberrypi systemd[1]: Reached target Local File Systems (Pre).
Mar 09 16:42:37 raspberrypi systemd[1]: Reached target Local Encrypted Volumes.
Mar 09 16:42:41 raspberrypi systemd[1]: Reached target Local File Systems.
Mar 09 16:42:41 raspberrypi systemd[1]: Reached target NFS client services.
Mar 09 16:42:41 raspberrypi systemd[1]: Reached target Remote File Systems (Pre).
Mar 09 16:42:41 raspberrypi systemd[1]: Reached target Remote File Systems.
Mar 09 16:42:42 raspberrypi systemd[1]: Reached target System Time Synchronized.
Mar 09 16:42:43 raspberrypi systemd[1]: Reached target System Initialization.
Mar 09 16:42:43 raspberrypi systemd[1]: Reached target Paths.
Mar 09 16:42:43 raspberrypi systemd[1]: Reached target Sockets.
Mar 09 16:42:43 raspberrypi systemd[1]: Reached target Timers.
Mar 09 16:42:43 raspberrypi systemd[1]: Reached target Basic System.
Mar 09 16:42:43 raspberrypi systemd[1]: Reached target Sound Card.
Mar 09 16:42:48 raspberrypi systemd[1]: Reached target Network.
Mar 09 16:42:54 raspberrypi systemd[1]: Reached target Bluetooth.
Mar 09 16:43:02 raspberrypi systemd[1]: Reached target Network is Online.
Mar 09 16:43:02 raspberrypi systemd[1]: Reached target Login Prompts.
</span><span class="gp">#</span>Mar 09 16:43:02 raspberrypi systemd[1]: Reached target Multi-User System.
<span class="go">Mar 09 16:43:02 raspberrypi systemd[1]: Reached target Graphical Interface.
</span></code></pre></div></div> <p>To see the exact target name use<br> <code class="language-plaintext highlighter-rouge">$ systemctl list-units --type=target</code></p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">UNIT                     LOAD ACTIVE SUB DESCRIPTION      
multi-user.target  loaded active active Multi-User System 
</span></code></pre></div></div> <p>For initial testing I used “multi-user.target” for the WantedBy<br> <code class="language-plaintext highlighter-rouge">$ sudo nano /lib/systemd/system/mytest.service</code></p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Unit]
Description=Creating my own systemd service

[Service]
ExecStart=/home/pi/myscript.py

[Install]
WantedBy=multi-user.target
</span></code></pre></div></div> <hr> <h2 id="enable-testservice-to-start-at-boot">Enable test.service to Start at Boot</h2> <p>Now we can enable our test.service to start our script (myscript.py) at boot<br> <code class="language-plaintext highlighter-rouge">$ sudo systemctl enable mytest.service</code><br> Will reply that a symlink was created<br> Reboot and check the journal logs of the last boot. A quick check is using egrep with the | (OR) ​ <code class="language-plaintext highlighter-rouge">$ journalctl -b | egrep 'Reached target|mytest|myscript'</code></p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Mar 13 14:13:27 raspberrypi systemd[1]: Reached target Swap.
Mar 13 14:13:28 raspberrypi systemd[1]: Reached target Local File Systems (Pre).
Mar 13 14:13:28 raspberrypi systemd[1]: Reached target Local Encrypted Volumes.
Mar 13 14:13:32 raspberrypi systemd[1]: Reached target Local File Systems.
Mar 13 14:13:32 raspberrypi systemd[1]: Reached target NFS client services.
Mar 13 14:13:32 raspberrypi systemd[1]: Reached target Remote File Systems (Pre).
Mar 13 14:13:32 raspberrypi systemd[1]: Reached target Remote File Systems.
Mar 13 14:13:33 raspberrypi systemd[1]: Reached target System Initialization.
Mar 13 14:13:33 raspberrypi systemd[1]: Reached target Paths.
Mar 13 14:13:33 raspberrypi systemd[1]: Reached target Sockets.
Mar 13 14:13:33 raspberrypi systemd[1]: Reached target Basic System.
Mar 13 14:13:33 raspberrypi systemd[1]: Reached target System Time Synchronized.
Mar 13 14:13:34 raspberrypi systemd[1]: Reached target Timers.
Mar 13 14:13:34 raspberrypi systemd[1]: Reached target Sound Card.
Mar 13 14:13:39 raspberrypi systemd[1]: Reached target Network.
</span><span class="gp">#</span>Mar 13 14:13:40 raspberrypi /home/pi/myscript.py[377]: Journal updated by /home/pi/myscript.py
<span class="gp">#</span>Mar 13 14:13:40 raspberrypi myscript.py[377]: Testing a script to be started by systemd at boot
<span class="gp">#</span>Mar 13 14:13:40 raspberrypi systemd[1]: mytest.service: Succeeded.
<span class="go">Mar 13 14:13:45 raspberrypi systemd[1]: Reached target Bluetooth.
Mar 13 14:13:50 raspberrypi systemd[617]: Reached target Paths.
Mar 13 14:13:50 raspberrypi systemd[617]: Reached target Timers.
Mar 13 14:13:50 raspberrypi systemd[617]: Reached target Sockets.
Mar 13 14:13:50 raspberrypi systemd[617]: Reached target Basic System.
Mar 13 14:13:50 raspberrypi systemd[617]: Reached target Default.
Mar 13 14:13:56 raspberrypi systemd[1]: Reached target Network is Online.
Mar 13 14:13:56 raspberrypi systemd[1]: Reached target Login Prompts.
Mar 13 14:13:56 raspberrypi systemd[1]: Reached target Multi-User System.
Mar 13 14:13:56 raspberrypi systemd[1]: Reached target Graphical Interface.
</span></code></pre></div></div> <hr> <p>If the script doesn’t start at the point you need it to there are many options. Here are some starting points and helpful commands. <a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html" target="_blank" rel="noopener noreferrer">freedesktop.org</a> and <a href="https://wiki.archlinux.org/title/Systemd" target="_blank" rel="noopener noreferrer">archlinux.org</a><br> To look at current system<br> <code class="language-plaintext highlighter-rouge">$ systemd-analyze</code><br> <code class="language-plaintext highlighter-rouge">$ systemd-analyze critical-chain</code><br> <code class="language-plaintext highlighter-rouge">$ systemd-analyze critical-chain mytest.service</code><br> mytest.service @9.376s<br> └─basic.target @9.338s<br> └─sockets.target @9.338s<br> └─triggerhappy.socket @9.338s<br> └─sysinit.target @9.323s</p> <p>For a graphical representation<br> <code class="language-plaintext highlighter-rouge">$ systemd-analyze plot &gt; boot_analysis.svg</code><br> Then view the boot_analysis.svg in a image viewer</p> <p>Example. I had a script on an OSMC setup that I wanted to start soon after network connection to get the IP address (the connection time varies after each boot). But I didn’t want the script to fail if no network connection was made. The IP address was just bonus information if available.</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Unit]
</span><span class="gp">After= #</span><span class="w"> </span>Additional criteria to start the script after a target or service
<span class="go">[Service]
Type=idle (delayed until all active jobs are dispatched)
</span><span class="gp">ExecStartPre=/bin/sleep 2 #</span><span class="w"> </span>added a 2sec delay
</code></pre></div></div> <p>Here’s the actual service file</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Unit]
Description=Display on WaveShare E-Paper
After=graphical.target NetworkManager-dispatcher.service

[Service]
User=osmc
Group=osmc

Type=idle
ExecStartPre=/bin/sleep 2
ExecStart=/home/osmc/E-ink/bin/e-ink-art.py
Restart=on-failure

[Install]
WantedBy=multi-user.target
</span></code></pre></div></div> <p>Another option is adding a .timer. In this approach you disable the main service (mytest.service) so it doesn’t automatically start at boot. Instead you create a timer unit that is enabled to start at boot and it starts mytest.service based on a delay or schedule.<br> To see current timers<br> <code class="language-plaintext highlighter-rouge">$ systemctl list-timers</code></p> <p>To create a timer (monotonic) for mytest.service<br> <code class="language-plaintext highlighter-rouge">$ sudo nano /lib/systemd/system/mytest.timer</code></p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Unit]
Description=Timer for mytest.service

[Timer]
OnBootSec=2                         
Unit=mytest.service

[Install]
WantedBy=timers.target
</span></code></pre></div></div> <p>Some more options including Realtimer too</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Timer]
OnBootSec=5min
</span><span class="gp">OnUnitActiveSec=1w    #</span><span class="w"> </span>and run every week
<span class="go">
[Timer]
OnCalendar=weekly
</span><span class="gp">Persistent=true            #</span><span class="w"> </span><span class="k">if </span>it missed last start run immediately
</code></pre></div></div> <p>Always run the systemctl daemon-reload command after creating new unit files or modifying existing unit files.</p> <p>The system will run as root so if you’re code opens files that are in your user directory (using Path.home()) you will need to add User/Group to the [Service]<br> Example</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[Service]
User=pi
Group=pi
</span></code></pre></div></div> <p>If you do <code class="language-plaintext highlighter-rouge">$ ls-lrt</code> in your directory you can see what the User/Group is for your file.</p> <h1 id="terms-and-systemctl-commands">Terms and systemctl commands</h1> <p>Quick terms</p> <ul> <li>systemd - Init system and service manager</li> <li>daemons – Non-interactive programs (typically end with ‘d’) that run in the background. Examples are cron, printing, ssh, ftp, filesystem mounts, etc.​</li> <li>init.d (/etc/init.d) - The init daemon is the first process started which then starts other processes, services, and daemons. units - Resources that systemd manages The type of resources is noted by the suffix (ie .service, .target, .timer, etc)</li> <li>.target - Typically files are started at a “target” point during the start up process. Used to synchronize and group units, similar to run-levels. multi-user.target is a common example. Target tree at freedesktop.org shows multi-user.target will not start until basic.target services have started.</li> <li>.service - Basic units for running processes</li> <li>.timer - Unit type that can control when .service units are executed (ie add a delay or scheduled at a specific time of day). Similar to scheduling in cron.</li> <li>.wants - symbolic links are created to startup the service</li> <li>systemctl - Utility or tool for interfacing with systemd. Can manage, start/stop specific services or the entire server. Enable/disable for starting at boot.</li> </ul> <p>​To familiarize yourself with systemd it helps to see the services and targets currently in use on your PC. <br> List all units in systemd path</p> <ul> <li><code class="language-plaintext highlighter-rouge">$ systemctl list-unit-files</code></li> </ul> <p>List of loaded and active units</p> <ul> <li><code class="language-plaintext highlighter-rouge">$ systemctl list-units</code></li> </ul> <p>List of inactive units</p> <ul> <li><code class="language-plaintext highlighter-rouge">$ systemctl list-units --all --state=inactive</code></li> </ul> <p>Can use –type filter to list different unit types<br> To see list of available targets</p> <ul> <li><code class="language-plaintext highlighter-rouge">$ systemctl list-unit-files --type=target</code></li> </ul> <p>List of active service units. Some have exited but could be restarted.</p> <ul> <li><code class="language-plaintext highlighter-rouge">$ systemctl list-unit-files --type=service</code></li> </ul> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>systemctl <span class="nt">--type</span><span class="o">=</span>service
<span class="go">ssh.service loaded active running OpenBSD Secure Shell server
ufw.service loaded active exited Uncomplicated firewall
virtualbox.service loaded active exited LSB: VirtualBox Linux kernel module
</span></code></pre></div></div> <p>To see only active and running service units<br> <code class="language-plaintext highlighter-rouge">$ systemctl list-unit-files --type=service --state=running</code></p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>systemctl <span class="nt">--type</span><span class="o">=</span>service <span class="nt">--state</span><span class="o">=</span>running
<span class="go">ssh.service loaded active running OpenBSD Secure Shell server
vncserver-x11-serviced.service loaded active running VNC Server in Service Mode daemon wpa_supplicant.service loaded active running WPA supplicant 
</span></code></pre></div></div> <p>To see dependencies of a specific service<br> <code class="language-plaintext highlighter-rouge">$ systemctl list-dependencies --all &lt;name.service&gt;</code></p> <p>To see logs from most recent boot<br> <code class="language-plaintext highlighter-rouge">$ journalctl -b</code></p> <p>Managing daemons with sysvinit vs systemd<br> This topic can be confusing since there was a migration from older “init” or “SystemV init” to the newer “systemd.” You’ll find references to both commands. systemctl is backward compatible and recommended utility.</p> <ol> <li>The system first checks ‘systemd’ folders <ul> <li>systemd (/lib/systemd/system and /etc/systemd/system)</li> <li><code class="language-plaintext highlighter-rouge">$ sudo systemctl &lt;command&gt; &lt;daemon&gt;</code></li> <li>example <code class="language-plaintext highlighter-rouge">$ sudo systemctl start ssh</code> </li> </ul> </li> <li>Second it checks System V “/etc/init.d” <ul> <li>sysvinit (/etc/init.d)</li> <li><code class="language-plaintext highlighter-rouge">$ sudo service &lt;daemon&gt; &lt;command&gt;</code></li> <li>example $ sudo service ssh start</li> <li>you may also see</li> <li><code class="language-plaintext highlighter-rouge">$ /etc/init.d/&lt;daemon&gt; &lt;command&gt;</code></li> <li>(note - there can be more folders configured to be searched) ​ Both control daemons with commands = start, stop, reload, restart, status. Use <code class="language-plaintext highlighter-rouge">$ sudo systemctl mask/unmask &lt;daemon&gt; </code> to prevent a service from starting (either automatically or manually) or to allow a service to always start. Example with the ssh daemon (sshd). service and systemctl give the same output</li> </ul> </li> </ol> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>service ssh status
<span class="go">● ssh.service - OpenBSD Secure Shell server
</span><span class="gp">Loaded: loaded (/lib/systemd/system/ssh.service;</span><span class="w"> </span>enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
<span class="go">Active: active (running) since Sun 2021-01
Docs: man:sshd(8)
man:sshd_config(5)
Process: 521 ExecStartPre=/usr/sbin/sshd -t (code=exited, status=0/SUCCESS)
Main PID: 549 (sshd)
</span></code></pre></div></div> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>systemctl status ssh
<span class="go">● ssh.service - OpenBSD Secure Shell server
</span><span class="gp">Loaded: loaded (/lib/systemd/system/ssh.service;</span><span class="w"> </span>enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
<span class="go">Active: active (running) since Sun 2021-01
Docs: man:sshd(8)
man:sshd_config(5)
Process: 521 ExecStartPre=/usr/sbin/sshd -t (code=exited, status=0/SUCCESS)
Main PID: 549 (sshd)
</span></code></pre></div></div> <hr> <hr> </article> </div> </main> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Sean Trautman. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a>. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>