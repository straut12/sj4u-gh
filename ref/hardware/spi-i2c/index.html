<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>SPI I2C Communication | ST</title> <meta name="author" content="Sean Trautman"/> <meta name="description" content="Intro to SPI I2C communication"/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="" id="highlight_theme_light"/> <link rel="shortcut icon" href="/assets/img/st-logo-transparent.png"/> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://straut12.github.io/ref/hardware/spi-i2c/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <div class="site-container"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">ST</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/"></a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Coding</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/ref/coding/git/">VScode Github</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/coding/bash/">Bash Shell</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/coding/python/">Python</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/coding/js/">JavaScript</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/coding/html/">Web HTML</a> </div> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Data Analysis</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/ref/data-analysis/data-collection/">data collection</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/data-analysis/databases/">databases</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/data-analysis/basic-charting/">basic charting</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/data-analysis/data-visualization/">data visualization</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/data-analysis/ml/">machine learning</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/data-analysis/statistics/">notes</a> </div> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Linux</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/ref/linux/linuxdistros/">Linux Options</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/desktop/">Desktop Appearance</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/software/">Installing SW</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/sharing/">File Sharing</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/vnc-ssh/">Remote vnc ssh</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/terminal/">Terminal cli</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/autostart/">Autostart systemd</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/logs/">Logs</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/ref/linux/list/">List of SW to Install</a> </div> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="site-body wrapper"> <aside class="site-sidebar" id="site-sidebar"> <nav class="toc"> <header><h4 class="toc__title">Table of Contents</h4></header> <ul class="toc__menu"> <li><a href="#communication-types">Communication Types</a></li> <li><a href="#spi">SPI</a></li> <li><a href="#i2c">I2C</a></li> <li><a href="#i2s">I2S</a></li> <li><a href="#uart-serial">UART (serial)</a></li> </ul> </nav> </aside> <main> <div class="post"> <p class="post-description">Intro to SPI I2C communication</p> <article> <h1 id="communication-types">Communication Types</h1> <p>Communicating with SPI, I2C, UART (I2S for digital audio) Below describes different communication methods between a RPi and an external device. <a href="../../../ref/hardware/hw-troubleshooting">PISCOPE</a> is a great way to see the waveforms (hi/lo sequences). â€‹ (SPI example below)</p> <div class="row"> <div class="col-md mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/hardware/piscope.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Device Tree is how the Pi supports multiple hardware configurations with a single kernel. To enable hardware interfaces use <code class="language-plaintext highlighter-rouge">$ sudo raspi-config and go to interfaces</code><br> You can also see in /boot/config.txt</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">dtparam=i2c_arm=on
dtparam=i2s=on
dtparam=spi=on
enable_uart=1
</span><span class="gp">dtoverlay=w1-gpio #</span><span class="w"> </span>One-wire communication. Can use with DS18B20 temp sensor  
</code></pre></div></div> <p>Default is pin 4. Can change with</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">dtoverlay=w1-gpio,gpiopin=x
</span></code></pre></div></div> <p>or use command <code class="language-plaintext highlighter-rouge">$ sudo modprobe w1-gpio</code><br> Can see devices discovered via 1-wire busses<br> <code class="language-plaintext highlighter-rouge">$ ls /sys/bus/w1/devices/</code> Typically use 4.7k pull-up resistor between GPIO and 3.3V.</p> <p>Note - multiple factors affect the speed of data transfer. Data speed is mainly for comparison.</p> <h1 id="spi">SPI</h1> <p>SPI is synchronous serial communication (serial peripheral interface) at medium or high speed. (32kbps-8Mbps) Typically use 4 wires</p> <ul> <li>MOSI or Din (master out slave in, send data from master to the device)</li> <li>MISO or Dout (master in slave out, master receives data from the device)</li> <li>SCLK (clock)</li> <li>CS or CE (Chip select, SS, used to select the device) Since SPI uses separate lines for receiving/transmitting it theoretically can be faster (Mbps) than I2C but requires more wires.</li> <li>SPI0 is enabled with dtparam=spi=on (cs = GPIO 8, 7)</li> <li>SPI1 is enabled with (1cs, 2cs, 3cs for number of chip select lines) <code class="language-plaintext highlighter-rouge">dtoverlay=spi1-1cs,cs0_pin=16 # change from 18 to 16</code> or <code class="language-plaintext highlighter-rouge">dtoverlay=spi1-3cs # three chip select lines (GPIO 18, 17, 16)</code> </li> </ul> <div class="row"> <div class="col-md mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/hardware/spi.svg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p><a href="https://commons.wikimedia.org/w/index.php?curid=11405368" target="_blank" rel="noopener noreferrer">SPI_timing_diagram.svg: en:User:Cburnettderivative work: Jordsan, CC BY-SA 3.0, via Wikimedia Commons</a></p> <p>SPI Example</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">spidev</span>

<span class="n">spi</span> <span class="o">=</span> <span class="n">spidev</span><span class="p">.</span><span class="nc">SpiDev</span><span class="p">()</span>
<span class="n">spi</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># bus 0, the second 0 can be 0 or 1 for CS0 or CS1.. can have multiple devices
</span><span class="n">spi</span><span class="p">.</span><span class="n">max_speed_hz</span> <span class="o">=</span> <span class="mi">1000000</span>

<span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">spi</span><span class="p">.</span><span class="nf">xfer</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="n">channel</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div></div> <p>SPI example from o-scope with MCP3008 (clock and data/MISO). Can use o-scope to confirm signal to Pi (MISO) is 3.3V and not 5V (Pi GPIO not rated for 5V)</p> <div class="row"> <div class="col-md mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/hardware/spi1.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-md mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/hardware/spi2.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h1 id="i2c">I2C</h1> <p>I2C (I squared C) is another synchronous serial communication (medium speed).</p> <ul> <li>It only uses two bidirectional lines.</li> <li>SDA (serial data line, half-duplex, send/receive must alternate)</li> <li>and SCL (serial clock line). Theoretical data transfer speed is slower (100kbps, 400kbps, etc) than SPI but requires fewer wires.</li> <li>The Pi will initiate the transfers. Data=GPIO2, Clock=GPIO3. I2C speed on RPi = 100KHz</li> <li>Pins: GPIO2(SDA) and GPIO3(SCL). Data sent in 8 bit bytes. Some tools <code class="language-plaintext highlighter-rouge">$ sudo apt-get install i2c-tools python-smbus</code><br> <code class="language-plaintext highlighter-rouge">$ sudo i2cdetect -y 1</code> </li> </ul> <div class="row"> <div class="col-md mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/hardware/i2c.svg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p><a href="https://commons.wikimedia.org/w/index.php?curid=1647146" target="_blank" rel="noopener noreferrer">By Marcin Floryan - Own work, Public Domain</a></p> <p>I2C example with ADS1115 (clock and data)</p> <div class="row"> <div class="col-md mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/hardware/i2c1.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-md mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/hardware/i2c2.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>I2C Example from <a href="https://pinout.xyz/pinout/i2c" target="_blank" rel="noopener noreferrer">https://pinout.xyz/pinout/i2c</a></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">smbus</span>
<span class="n">DEVICE_BUS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEVICE_ADDR</span> <span class="o">=</span> <span class="mh">0x15</span>
<span class="n">bus</span> <span class="o">=</span> <span class="n">smbus</span><span class="p">.</span><span class="nc">SMBus</span><span class="p">(</span><span class="n">DEVICE_BUS</span><span class="p">)</span>
<span class="n">bus</span><span class="p">.</span><span class="nf">write_byte_data</span><span class="p">(</span><span class="n">DEVICE_ADDR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span>
</code></pre></div></div> <h1 id="i2s">I2S</h1> <p>I2S (I squared S) is different than I2C. I2S is used for PCM (pulse code modulation) audio where low jitter is needed. It uses a</p> <ul> <li>word-select (WS)</li> <li>clock (SCK)</li> <li>data line, multiplexed serial data line (SD). PCM is a method to digitally represent analog signals. By wdwd - Own work, CC BY 3.0 CLK = GPIO 18 DIN = GPIO 20 DOUT = GPIO 21 FS = GPIO 19</li> </ul> <div class="row"> <div class="col-md mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/hardware/i2s.svg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p><a href="https://commons.wikimedia.org/w/index.php?curid=16579640" target="_blank" rel="noopener noreferrer">By wdwd - Own work, CC BY 3.0</a></p> <h1 id="uart-serial">UART (serial)</h1> <p>Universal Asynchronous Reception and Transmission.</p> <ul> <li>Often thru USB-to-serial converter, acting as if the USB is a serial port.</li> <li>The Pi or device can initiate data transfer. Data is transmitted/received one bit a time, sequentially, without a clock.</li> <li>Instead of clock, start/stop bits are used to synchronize.</li> <li>Have to pay attention to the TTL (transistor-transistor-logic) level. Pi uses 3.3V, vs Arduino 5V TTL or RS232 which could vary from -25 to +25V (travel longer distance than I2C/SPI).</li> <li>If using pins for receiving/transmitting: RX(GPIO15) and TX(GPIO14). RX goes to TX, TX goes to RX between devices. Speed is medium/low in 8 bit bytes (start, 8 data bits, stop). There is no parity.</li> </ul> <div class="row"> <div class="col-7 mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/hardware/uart.svg" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p><a href="https://commons.wikimedia.org/w/index.php?curid=8453185" target="_blank" rel="noopener noreferrer">By Plugwash at en.wikipedia. - Transferred from en.wikipedia, Public Domain</a></p> <p>When using USB and device is connected can use these commands.</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/ttyUSB<span class="k">*</span>
<span class="go">crw-rw---- 1 root dialout 188, 0 Apr 6 12:41 /dev/ttyUSB0 
</span></code></pre></div></div> <p>To find out if Pi is in the group dialout use<br> <code class="language-plaintext highlighter-rouge">$ id </code>(typically only an issue if using non Raspberry Pi OS)<br> To add<br> <code class="language-plaintext highlighter-rouge">$ sudo usermod -a -G dialout pi</code></p> <p>â€‹Serial communication usually done with TTL.</p> <ul> <li>Baud is data rate or how fast the data can be sent over the serial line or number of bits per second(bps). ie 9600bps, 115200bps (can vary from 50 to 230400). Both devices should use the same Baud rate.</li> <li>Logic high, 1, will be Vcc</li> <li>Logic low, 0, will be 0V</li> <li>(Parallel interface would be able to transmit multiple bits at a time but requires many more wires)</li> </ul> <p>Wiringpi example from https://pinout.xyz/pinout/i2c</p> <pre><code class="language-C">import wiringpi
wiringpi.wiringPiSetup()
serial = wiringpi.serialOpen('/dev/ttyAMA0',9600)
wiringpi.serialPuts(serial,'hello world!')
</code></pre> <div class="row"> <div class="col-md mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/hardware/uart2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p><a href="https://commons.wikimedia.org/w/index.php?curid=8453185" target="_blank" rel="noopener noreferrer">By Plugwash at en.wikipedia. - Transferred from en.wikipedia, Public Domain</a></p> <hr> <hr> </article> </div> </main> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> Â© Copyright 2023 Sean Trautman. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a>. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>